<template>
  <require from='./elems/md-shadow'></require>
  <require from='./elems/md-drawer'></require>
  <require from='./elems/md-table'></require>
  <require from="./elems/md-input"></require>
  <require from="./elems/md-select"></require>
  <require from="./elems/md-switch"></require>
  <require from="./elems/md-checkbox"></require>
  <require from="./elems/md-button"></require>
  <require from="./elems/md-menu"></require>
  <require from="./elems/md-autocomplete"></require>
  <require from="./elems/md-snackbar"></require>
  <md-drawer autofocus>
    <md-input
      value.bind="filter"
      autoselect
      style="padding:0 8px; width:auto">
      Filter shipments ${ role.account } you
    </md-input>
    <md-switch
      checked.one-time="role.account == 'to'"
      click.delegate="swapRole()"
      style="margin:-33px 0 0 185px;">
    </md-switch>
    <a
      repeat.for="shipment of shipments[role.account] | filter:filter"
      class="mdl-navigation__link ${ shipment._id == $parent.shipment._id ? 'mdl-navigation__link--current' : ''}"
      click.delegate="selectShipment(shipment)">
      <div class="mdl-typography--title">
        ${ shipment._rev ? shipment.account[role.partner].name : 'Create'}
      </div>
      ${ shipment._rev ? '#0'+shipment.tracking+', '+shipment.status : 'new shipment '+role.account+' you' }
    </a>
  </md-drawer>
  <section class="mdl-grid au-animate">
    <div md-shadow="2" class="mdl-card mdl-cell mdl-cell--4-col full-height">
      <div class="mdl-card__title" style="display:block;">
        <div class="mdl-card__title-text" style="text-transform:capitalize">
          ${ shipment._rev ? 'Shipment #0'+shipment.tracking : 'New Shipment '+role.account+' You' }
        </div>
        <div style="margin-top:3px; margin-bottom:-25px">
          <strong>${transactions.length}</strong> items worth
          <strong>$${ transactions | value }</strong>
        </div>
      </div>
      <form class="mdl-card__supporting-text" style="font-size:16px;">
        <md-select
          if.bind="role.account == 'from' || shipment._rev"
          style="width:100%"
          value.bind="shipment"
          options.bind="shipments[role.account]"
          default.bind="'New Tracking #'"
          property="tracking">
          Tracking #
        </md-select>
        <md-input
          if.bind="role.account == 'to' && ! shipment._rev"
          style="width:100%"
          value.bind="shipment.tracking">
          Tracking #
        </md-input>
        <md-select
          style="width:100%;"
          value.bind="shipment.account.from"
          options.bind="(shipment.account.from.disabled || role.account == 'from' || shipment._rev) ? [shipment.account.from] : accounts[role.account]"
          property="name"
          required
          disabled.bind="role.account == 'from'">
          <!-- disabled is for highlighting the current role -->
          From
        </md-select>
        <md-select
          style="width:100%;"
          value.bind="shipment.account.to"
          options.bind="(shipment.account.to.disabled || role.account == 'to' || shipment._rev) ? [shipment.account.to] : accounts[role.account]"
          property="name"
          required
          disabled.bind="role.account == 'to'">
          <!-- disabled is for highlighting the current role -->
          To
        </md-select>
        <md-select
          style="width:32%;"
          value.bind="shipment.status"
          options.bind="stati"
          disabled.bind="! shipment._rev">
          Status
        </md-select>
        <md-input
          type="date"
          style="width:64%; margin-top:20px"
          value.bind="shipment[shipment.status+'At']"
          disabled.bind="! shipment._rev"
          input.delegate="saveShipment() & debounce:1000">
        </md-input>
        <!-- <md-select
          style="width:100%"
          value.bind="attachment.name"
          change.delegate="getAttachment()"
          options.bind="['','Shipping Label', 'Manifest']"
          disabled.bind=" ! shipment._id || shipment._id != tracking._id">
          Attachment
        </md-select>
        <md-button color
          if.bind="attachment.name"
          click.delegate="upload.click()"
          style="position:absolute; right:18px; margin-top:-48px; height:24px; line-height:24px"
          disabled.bind=" ! shipment._id || shipment._id != tracking._id">
          Upload
        </md-button>
        <input
          type="file"
          ref="upload"
          change.delegate="setAttachment(upload.files[0])"
          style="display:none">
        <div if.bind="attachment.url" style="width: 100%; padding-top:56px; padding-bottom:129%; position:relative;">
          <embed
            src.bind="attachment.url"
            type.bind="attachment.type"
            style="position:absolute; height:100%; width:100%; top:0; bottom:0">
        </div> -->
        <!-- The above padding / positioning keeps a constant aspect ratio for the embeded pdf  -->
      </form>
      <div class="mdl-card__actions">
        <md-button color raised
          style="width:100%"
          if.bind="! shipment._rev && shipment._id == transactions[0].shipment._id"
          form
          click.delegate="createShipment()">
          Create Shipment With ${ diffs.length || 'No' } Items
        </md-button>
        <md-button color raised
          style="width:100%"
          if.bind="transactions.length && shipment._id == transactions[0].shipment._id && role.account == 'to'"
          disabled.bind="! diffs.length"
          click.delegate="saveInventory()">
          ${ transactions[diffs[0]].verifiedAt ? 'Remove '+diffs.length+' Items from Inventory' : 'Save '+diffs.length+' Items to Inventory'}
        </md-button>
        <md-button color raised
          style="width:100%"
          if.bind="transactions.length && shipment._id != transactions[0].shipment._id"
          disabled.bind="! diffs.length || ! shipment.account.to._id"
          click.delegate="shipment._rev ? moveTransactionsToShipment(shipment) : createShipment()">
          Move ${ diffs.length } Items to This Shipment
        </md-button>
      </div>
    </div>
    <div md-shadow="2" class="mdl-card mdl-cell mdl-cell--8-col full-height">
      <!-- disabled.bind="! searchReady" -->
      <md-autocomplete
        placeholder="Add Drugs by Generic Name or NDC..."
        value.bind="term"
        input.delegate="search()"
        keyup.delegate="autocompleteShortcut($event)"
        disabled.bind="role.account == 'to' && ! shipment._rev"
        style="margin:0px 16px">
        <table md-table>
          <tr
            repeat.for="drug of drugs"
            click.delegate="addTransaction(drug)">
            <td class="mdl-data-table__cell--non-numeric" innerHTML.bind="drug | drugName:regex" style="white-space:normal; max-width:70%"></td>
            <td class="mdl-data-table__cell--non-numeric" style="max-width:30%">${ drug._id }</td>
          </tr>
        </table>
      </md-autocomplete>
      <md-menu style="position:absolute; z-index:2; top:10px; right:5px;" id.bind="a1">
        <!-- workaround for boolean attributes https://github.com/aurelia/templating/issues/76 -->
        <li
          show.bind="transactions.length"
          click.delegate="exportCSV()">
          Export CSV
        </li>
        <li
          show.bind="!transactions.length"
          disabled>
          Export CSV
        </li>
        <li
          click.delegate="$file.click()">
          Import CSV
        </li>
      </md-menu>
      <input ref="$file" change.delegate="importCSV()" style="display:none" type="file" />
      <div style="overflow-y:scroll; margin:8px 0px 8px 16px;">
        <table md-table style="width:calc(100% - 16px)">
          <thead>
            <tr>
              <th style="width:15px"></th>
              <th class="mdl-data-table__cell--non-numeric" style="padding-left:0">Drug</th>
              <th class="mdl-data-table__cell--non-numeric" style="width:90px;padding-left:0">Ndc</th>
              <th style="text-align:left; width:40px; padding-left:0">Exp</th>
              <th style="text-align:left; width:40px">Qty</th>
              <th style="text-align:left; width:10px; padding-left:0"></th>
            </tr>
          </thead>
          <tbody>
            <tr style="padding-top:7px;" repeat.for="transaction of transactions">
              <td style="padding:0 0 0 8px">
                <!-- if you are selecting new items you received to add to inventory, do not confuse these with the currently checked items -->
                <!-- if you are selecting items to move to a new shipment, do not allow selection of items already verified by recipient e.g do not mix saving new items and removing old items, you must do one at a time -->
                <!-- since undefined != false we must force both sides to be booleans just to show a simple inequality. use verifiedAt directly rather than isChecked because autocheck coerces isChecked to be out of sync -->
                <md-checkbox
                  disabled.bind="(role.account == 'to' && diffs.length && ! transactions[diffs[0]].verifiedAt != ! transaction.verifiedAt) || (role.account == 'to' && transaction.verifiedAt && transaction.shipment._id != shipment._id) || (role.account == 'from' && transaction.verifiedAt)"
                  click.delegate="manualCheck($index)"
                  checked.bind="isChecked[$index]">
                </md-checkbox>
              </td>
              <td click.delegate="selectRow($index)" class="mdl-data-table__cell--non-numeric" style="max-width:300px; white-space:normal; padding-left:0">
                ${ transaction.drug | drugName }
              </td>
              <td click.delegate="selectRow($index)" class="mdl-data-table__cell--non-numeric" style="padding:0">
                ${ transaction.drug._id }
                <!-- <md-select
                  style="margin-left:-3px"
                  value.bind="package"
                  options.bind="['', '00','01','10','90']">
                </md-select> -->
              </td>
              <td style="padding:0">
                ${ transaction.exp[role.partner] | date}
                <md-input
                  id.bind="'exp_'+$index"
                  ref="input"
                  input.delegate="saveTransaction(transaction) & debounce:1000"
                  input.trigger="autoCheck($index)"
                  pattern="(0?[1-9]|1[012])/\d{2}"
                  value.bind="transaction.exp[role.account] | date"
                  style="width:40px; margin-bottom:-8px"
                  placeholder>
                </md-input>
              </td>
              <td style="padding:0">
                ${ transaction.qty[role.partner] }
                  <!-- input event is not triggered on enter, so use keyup for qtyShortcutes instead   -->
                  <md-input
                    input.delegate="saveTransaction(transaction) & debounce:1000"
                    keyup.delegate="qtyShortcuts($event, $index)"
                    type="number"
                    value.bind="transaction.qty[role.account] | number"
                    style="width:40px; margin-bottom:-8px"
                    placeholder>
                  </md-input>
              </td>
              <td style="padding:0 16px">
                <a if.bind="shipment._rev" href="/#/records/${ transaction._id }" tabindex="-1">
                   <i class="material-icons" style="font-size:15px; vertical-align:text-top">history</i>
                </a>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <md-snackbar ref="snackbar"></md-snackbar>
  </section>
</template>
