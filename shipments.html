<template>
  <require from='./elems/md-shadow'></require>
  <require from='./elems/md-drawer'></require>
  <require from='./elems/md-table'></require>
  <require from="./elems/md-input"></require>
  <require from="./elems/md-select"></require>
  <require from="./elems/md-switch"></require>
  <require from="./elems/md-checkbox"></require>
  <require from="./elems/md-button"></require>
  <require from="./elems/md-autocomplete"></require>
  <require from="./elems/md-snackbar"></require>
  <md-drawer autofocus>
    <md-input
      value.bind="filter"
      autoselect
      style="padding:0 8px; width:auto">
      Filter shipments ${ role.account } you
    </md-input>
    <md-switch
      checked.one-way="role.account == 'to'"
      click.delegate="swapRole()"
      style="margin:-45px 0 0 197px;">
    </md-switch>
    <a
      repeat.for="shipment of shipments[role.account] | filter:filter"
      class="mdl-navigation__link ${ shipment._id == $parent.shipment._id ? 'mdl-navigation__link--current' : ''}"
      click.delegate="selectShipment(shipment)">
      <div class="mdl-typography--title">
        ${ shipment._id ? shipment.account[role.partner].name : 'Create'}
      </div>
      ${ shipment._id ? '#0'+shipment.tracking+', '+shipment.status : 'Shipment From You' }
    </a>
  </md-drawer>
  <section class="mdl-grid au-animate">
    <div md-shadow="2" class="mdl-card mdl-cell mdl-cell--4-col" style="height:calc(100vh - 96px);">
      <div class="mdl-card__title" style="display:block;">
        <div class="mdl-card__title-text">
          ${ shipment._id ? 'Shipment #0'+shipment.tracking : 'Shipment From You' }
        </div>
        <div style="margin-bottom:-5px">
          <strong>${transactions.length}</strong> items worth
          <strong>$${ transactions | value }</strong>
        </div>
      </div>
      <!-- Put calculated height here not on the card because changing height made input shift up and down when select changed values -->
      <div class="mdl-card__supporting-text" style="font-size:16px; overflow-y:scroll; height:calc(100% - 160px)">
        <md-select
          style="width:100%"
          value.bind="tracking"
          options.bind="shipments[role.account]"
          change.delegate="setAccounts()"
          property="tracking">
          Tracking #
        </md-select>
        <!-- css="${ role.partner == 'from' && 'font-weight:bold;' }" -->
        <md-select
          style="width:100%;"
          value.bind="from"
          options.bind="role.partner == 'from' ? accounts : [account]"
          property="name"
          required
          disabled.bind="tracking._id || role.account == 'from'">
          From
        </md-select>
        <!-- css = "${ role.partner == 'to' && 'font-weight:bold;' }" -->
        <md-select
          style="width:100%;"
          value.bind="to"
          options.bind="role.partner == 'to' ? accounts : [account]"
          property="name"
          required
          disabled.bind="tracking._id || role.account == 'to'">
          To
        </md-select>
        <md-select
          style="width:32%"
          value.bind="shipment.status"
          options.bind="stati"
          disabled.bind="! shipment._id"
          >
          Status
        </md-select>
        <md-input
          type="date"
          style="width:64%"
          value.bind="shipment[shipment.status+'At']"
          disabled.bind="! shipment._id"
          focusout.delegate="saveShipment()">
        </md-input>
        <md-select
          style="width:100%"
          value.bind="attachment.name"
          change.delegate="getAttachment()"
          options.bind="['','Shipping Label', 'Manifest']"
          disabled.bind=" ! shipment._id || shipment._id != tracking._id">
          Attachment
        </md-select>
        <md-button color
          if.bind="attachment.name"
          click.delegate="upload.click()"
          style="position:absolute; right:18px; margin-top:-48px; height:24px; line-height:24px"
          disabled.bind=" ! shipment._id || shipment._id != tracking._id">
          Upload
        </md-button>
        <input
          type="file"
          ref="upload"
          change.delegate="setAttachment(upload.files[0])"
          style="display:none">
        <!-- The below padding / positioning keeps a constant aspect ratio for the embeded pdf  -->
        <div if.bind="attachment.url" style="width: 100%; padding-top:56px; padding-bottom:129%; position:relative;">
          <embed
            src.bind="attachment.url"
            type.bind="attachment.type"
            style="position:absolute; height:100%; width:100%; top:0; bottom:0">
        </div>
      </div>
      <div class="mdl-card__actions">
        <md-button color raised
          style="width:100%"
          if.bind="! shipment._id && ! tracking._id"
          disabled.bind="! from.name || ! to.name"
          click.delegate="createShipment()">
          Create Shipment With ${ checkmarks.length ? 'Selected' : 'No Items'}
        </md-button>
        <md-button color raised
          style="width:100%"
          if.bind="shipment._id && shipment._id == tracking._id && role.account == 'to'"
          disabled.bind="! diffs.length"
          click.delegate="saveInventory()">
          Save Selected to Inventory
        </md-button>
        <md-button color raised
          style="width:100%"
          if.bind="shipment._id != tracking._id"
          disabled.one-way="! checkmarks.length"
          click.delegate="moveShipment()">
          Move Selected to Shipment
        </md-button>
      </div>
    </div>
    <div md-shadow="2" class="mdl-card mdl-cell mdl-cell--8-col" style="height:calc(100vh - 96px);">
  <!-- disabled.bind="! searchReady" -->
      <md-autocomplete
        placeholder.bind="'Add Drugs by Generic Name or NDC...'"
        value.bind="term"
        input.delegate="search()"
        style="margin:0px 16px">
        <table md-table>
          <tr
            repeat.for="drug of drugs"
            click.delegate="addTransaction(drug)">
            <td class="mdl-data-table__cell--non-numeric" innerHTML.bind="drug | drugName:regex" style="white-space:normal; max-width:70%"></td>
            <td class="mdl-data-table__cell--non-numeric" style="max-width:30%">${ drug._id }</td>
          </tr>
        </table>
      </md-autocomplete>
      <md-button color
        style="position:absolute; z-index:2; right:16px; top:10px; height:24px; line-height:24px">
        Import CSV
      </md-button>
      <div style="overflow-y:scroll">
        <table md-table style="margin:0 16px; width:calc(100% - 32px)">
          <thead>
            <tr>
              <th></th>
              <th class="mdl-data-table__cell--non-numeric" style="padding-left:0">Drug</th>
              <th class="mdl-data-table__cell--non-numeric" style="width:90px;padding-left:0">Ndc</th>
              <!-- <th style="text-align:left; width:5%">Lot</th> -->
              <th style="text-align:left; width:40px; padding:initial 0">Exp</th>
              <th style="text-align:left; width:40px">Qty</th>
              <th style="text-align:left; width:10px; padding:initial 0"></th>
            </tr>
          </thead>
          <tbody>
            <tr ref="form" style="padding-top:7px;" repeat.for="transaction of transactions">
              <td style="width:15px; padding:0 0 0 8px">
                <md-checkbox
                  disabled.bind="role.account == 'from' && shipment.shipped_at"
                  checked.one-way="checkmarks.indexOf($index) > -1"
                  click.delegate="check($index)">
                </md-checkbox>
              </td>
                ${ transaction.drug | drugName }
              </td>
                ${ transaction.drug._id }
                <!-- <md-select
                  style="margin-left:-3px"
                  value.bind="package"
                  options.bind="['', '00','01','10','90']">
                </md-select> -->
              </td>
              <!-- <td>
                ${ transaction.lot[role.partner] }
                <md-input
                  focusout.delegate="saveTransaction(transaction, $event, form)"
                  value.bind="transaction.lot[role.account]"
                  style="width:60px;"
                  placeholder>
                </md-input>
              </td> -->
              <td style="padding:0">
                ${ transaction.exp[role.partner] }
                <md-input
                  focusout.delegate="saveTransaction(transaction, $event, form)"
                  pattern="([1-9]|1[012])/\d{2}"
                  value.bind="transaction.exp[role.account]"
                  style="width:40px;"
                  placeholder>
                </md-input>
              </td>
              <td style="padding:0">
                ${ transaction.qty[role.partner] }
                <md-input
                  focusout.delegate="saveTransaction(transaction, $event, form)"
                  keyup.delegate="qtyShortcuts(transaction, $event, $index)"
                  type="number"
                  value.bind="transaction.qty[role.account]"
                  style="width:40px;"
                  placeholder>
                </md-input>
              </td>
              <td style="padding:0 16px">
                <a if.bind="shipment._id" href="/#/records/${ transaction._id }" tabindex="-1">
                   <i class="material-icons" style="font-size:15px; vertical-align:text-top">history</i>
                </a>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <md-snackbar ref="snackbar"></md-snackbar>
  </section>
</template>
