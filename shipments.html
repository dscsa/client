<template>
  <require from='./elems/md-shadow'></require>
  <require from='./elems/md-drawer'></require>
  <require from='./elems/md-table'></require>
  <require from="./elems/md-input"></require>
  <require from="./elems/md-select"></require>
  <require from="./elems/md-switch"></require>
  <require from="./elems/md-checkbox"></require>
  <require from="./elems/md-button"></require>
  <require from="./elems/md-autocomplete"></require>
  <md-drawer>
    <md-input
      value.bind="filter"
      style="padding:0 8px; width:auto">
      Filter shipments ${ role.account } you
    </md-input>
    <md-switch
      checked.one-way="role.account == 'to'"
      click.delegate="swapRole()"
      style="margin:-45px 0 0 197px;">
    </md-switch>
    <a
      repeat.for="shipment of shipments[role.account] | filter:filter"
      class="mdl-navigation__link ${ shipment._id == $parent.shipment._id ? 'mdl-navigation__link--current' : ''}"
      click.delegate="select(shipment)">
      <div class="mdl-typography--title">
        ${ shipment[role.partner].name || 'New shipment' }
      </div>
      ${ shipment._id ? '#'+shipment.tracking+', '+shipment.status : 'Create New Label' }
    </a>
  </md-drawer>
  <section class="mdl-grid">
    <div md-shadow="2" class="mdl-card mdl-cell mdl-cell--4-col">
      <div class="mdl-card__title mdl-grid">
        <div
          class="mdl-card__title-text mdl-cell mdl-cell--12-col"
          style="text-transform:capitalize">
          Shipment ${ role.account } you
        </div>
        <div class="mdl-cell mdl-cell--12-col">
          <strong>XXX</strong> units from
          <strong>${transactions.length}</strong> items worth
          <strong>$XXX</strong>
        </div>
      </div>
      <div class="mdl-card__supporting-text" style="font-size:16px;">
        <md-select
          style="width:100%"
          value.bind="tracking"
          options.bind="shipments[role.account]"
          change.delegate="setAccounts()"
          property="tracking">
          Tracking #
        </md-select>
        <md-select
          style="width:100%"
          value.bind="from"
          options.bind="role.partner == 'from' ? accounts : [account]"
          property="name"
          required
          disabled.bind="tracking._id || role.account == 'from'">
          From
        </md-select>
        <md-select
          style="width:100%"
          value.bind="to"
          options.bind="role.partner == 'to' ? accounts : [account]"
          property="name"
          required
          disabled.bind="tracking._id || role.account == 'to'">
          To
        </md-select>
        <div class="mdl-grid" style="padding:0;">
          <md-select
            style="margin-left:0"
            value.bind="shipment.status"
            options.bind="stati"
            class="mdl-cell mdl-cell--4-col"
            disabled.bind="! shipment._id">
            Status
          </md-select>
          <md-input
            value.bind="shipment[shipment.status+'_at']"
            type="date"
            style="padding-top:20px"
            class="mdl-cell mdl-cell--8-col"
            disabled.bind="! shipment._id"
            focusout.delegate="save()">
          </md-input>
        </div>
        <md-select
          style="width:100%"
          value.bind="attachment.name"
          change.delegate="getAttachment()"
          options.bind="['','Shipping Label', 'Manifest']"
          disabled.bind=" ! shipment._id || shipment._id != tracking._id">
          Attachment
        </md-select>
        <md-button color
          if.bind="attachment.name"
          click.delegate="upload.click()"
          style="position:absolute; right:18px; margin-top:-48px; height:24px; line-height:24px"
          disabled.bind=" ! shipment._id || shipment._id != tracking._id">
          Upload
        </md-button>
        <input
          type="file"
          ref="upload"
          change.delegate="setAttachment(upload.files[0])"
          style="display:none">
        <!-- The below padding / positioning keeps a constant aspect ratio for the embeded pdf  -->
        <div style="width: 100%; padding-top:56px; padding-bottom:129%; position:relative;">
          <embed
            if.bind="attachment.url"
            src.bind="attachment.url"
            type.bind="attachment.type"
            style="position:absolute; height:100%; width:100%; top:0; bottom:0">
        </div>
        <md-button color raised
          style="width:100%"
          if.bind="! shipment._id && ! tracking._id"
          disabled.bind="! from.name || ! to.name"
          click.delegate="create()">
          Create Shipment With ${ checks.length ? 'Selected' : 'No Items'}
        </md-button>
        <md-button color raised
          style="width:100%"
          if.bind="shipment._id && shipment._id == tracking._id && role.account == 'to'"
          disabled.bind="! diffs.length"
          click.delegate="saveInventory()">
          Save Selected to Inventory
        </md-button>
        <md-button color raised
          style="width:100%"
          if.bind="shipment._id != tracking._id"
          disabled.bind="! checks.length"
          click.delegate="move()">
          Move Selected to Shipment
        </md-button>
      </div>
    </div>
    <div md-shadow="2" class="mdl-card mdl-cell mdl-cell--8-col">
      <md-autocomplete
        style="margin:0px 16px -55px 16px"
        md-floating-label
        value.bind="search"
        query.bind="drugs.search"
        select.bind="addTransaction"
        placeholder="Search to add drugs...">
      </md-autocomplete>
      <md-button color
        style="position:absolute; z-index:2; right:16px; top:10px; height:24px; line-height:24px">
        Import CSV
      </md-button>
      <table md-table style="margin:0 16px; width:calc(100% - 32px)">
        <thead>
          <tr>
            <th style="width:4%;"></th>
            <th class="mdl-data-table__cell--non-numeric">Drug</th>
            <th>NDC</th>
            <th>Value</th>
            <th style="text-align:left; width:5%">Lot</th>
            <th style="text-align:left; width:5%; padding-left:0px">Exp</th>
            <th style="text-align:left; width:5%">Qty</th>
          </tr>
        </thead>
        <tbody>
          <tr ref="form" style="padding-top:7px;" repeat.for="transaction of transactions">
            <td style="padding-left:10px;">
              <md-checkbox
                disabled.bind="shipment._id && role.account == 'from'"
                checked.one-way="checks.indexOf($index) > -1"
                click.delegate="check($index)">
              </md-checkbox>
            </td>
            <td class="mdl-data-table__cell--non-numeric">
              <a href="/#/records/${ transaction._id }">${ transaction.names.join(', ') } ${ transaction.form }</a>
            </td>
            <td style="padding-top:9px">
              ${ transaction.drug }-
              <md-select
                style="margin-left:-3px"
                value.bind="package"
                options.bind="['', '00','01','10','90']">
              </md-select>
            </td>
            <td>${ (transaction.wholesale.price * (transaction.qty.to || transaction.qty.from || 0)).toFixed(2) }</td>
            <td style="padding-top:8px">
              ${ transaction.lot[role.partner] }
              <md-input
                focusout.delegate="drugs.save(transaction, $event, form)"
                value.bind="transaction.lot[role.account]"
                style="width:60px;"
                placeholder>
              </md-input>
            </td>
            <td style="padding:8px 0 0 0">
              ${ transaction.exp[role.partner] }
              <md-input
                focusout.delegate="drugs.save(transaction, $event, form)"
                pattern="([1-9]|1[012])/\d{2}"
                value.bind="transaction.exp[role.account]"
                style="width:40px;"
                placeholder>
              </md-input>
            </td>
            <td style="padding-top:8px">
              ${ transaction.qty[role.partner] }
              <md-input
                focusout.delegate="drugs.save(transaction, $event, form)"
                keyup.delegate="qtyShortcuts(transaction, $event, $index)"
                type="number"
                value.bind="transaction.qty[role.account]"
                style="width:40px;"
                placeholder>
              </md-input>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</template>
