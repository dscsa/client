<template>
  <require from='./elems/md-shadow'></require>
  <require from='./elems/md-drawer'></require>
  <require from='./elems/md-table'></require>
  <require from="./elems/md-input"></require>
  <require from="./elems/md-select"></require>
  <require from="./elems/md-switch"></require>
  <require from="./elems/md-checkbox"></require>
  <require from="./elems/md-button"></require>
  <require from="./elems/md-autocomplete"></require>
  <require from="./elems/md-snackbar"></require>
  <md-drawer autofocus>
    <md-input
      value.bind="filter"
      autoselect
      style="padding:0 8px; width:auto">
      Filter shipments ${ role.account } you
    </md-input>
    <md-switch
      checked.one-way="role.account == 'to'"
      click.delegate="swapRole()"
      style="margin:-33px 0 0 197px;">
    </md-switch>
    <a
      repeat.for="shipment of shipments[role.account] | filter:filter"
      class="mdl-navigation__link ${ shipment._id == $parent.shipment._id ? 'mdl-navigation__link--current' : ''}"
      click.delegate="selectShipment(shipment)">
      <div class="mdl-typography--title">
        ${ shipment._id ? shipment.account[role.partner].name : 'Create'}
      </div>
      ${ shipment._id ? '#0'+shipment.tracking+', '+shipment.status : 'Shipment from Inventory' }
    </a>
  </md-drawer>
  <section class="mdl-grid au-animate">
    <div md-shadow="2" class="mdl-card mdl-cell mdl-cell--4-col full-height">
      <div class="mdl-card__title" style="display:block;">
        <div class="mdl-card__title-text">
          ${ shipment._id ? 'Shipment #0'+shipment.tracking : 'Shipment from Inventory' }
        </div>
        <div style="margin-bottom:-5px">
          <strong>${transactions.length}</strong> items worth
          <strong>$${ transactions | value }</strong>
        </div>
      </div>
      <!-- Put calculated height here not on the card because changing height made input shift up and down when select changed values -->
      <div class="mdl-card__supporting-text" style="font-size:16px;">
        <md-select
          style="width:100%"
          value.bind="tracking"
          options.bind="shipments[role.account]"
          change.delegate="setSelects(true)"
          property="tracking">
          Tracking #
        </md-select>
        <!-- css="${ role.partner == 'from' && 'font-weight:bold;' }" -->
        <md-select
          style="width:100%;"
          value.bind="from"
          options.bind="role.partner == 'from' ? accounts : [account]"
          property="name"
          required
          disabled.bind="tracking._id || role.account == 'from'">
          From
        </md-select>
        <!-- css = "${ role.partner == 'to' && 'font-weight:bold;' }" -->
        <md-select
          style="width:100%;"
          value.bind="to"
          options.bind="role.partner == 'to' ? accounts : [account]"
          property="name"
          required
          disabled.bind="tracking._id || role.account == 'to'">
          To
        </md-select>
        <md-select
          style="width:32%;"
          value.bind="shipment.status"
          options.bind="stati"
          disabled.bind="! shipment._id">
          Status
        </md-select>
        <md-input
          type="date"
          style="width:64%; margin-top:20px"
          value.bind="shipment[shipment.status+'At']"
          disabled.bind="! shipment._id"
          input.delegate="saveShipment() & debounce:1000">
        </md-input>
        <!-- <md-select
          style="width:100%"
          value.bind="attachment.name"
          change.delegate="getAttachment()"
          options.bind="['','Shipping Label', 'Manifest']"
          disabled.bind=" ! shipment._id || shipment._id != tracking._id">
          Attachment
        </md-select>
        <md-button color
          if.bind="attachment.name"
          click.delegate="upload.click()"
          style="position:absolute; right:18px; margin-top:-48px; height:24px; line-height:24px"
          disabled.bind=" ! shipment._id || shipment._id != tracking._id">
          Upload
        </md-button>
        <input
          type="file"
          ref="upload"
          change.delegate="setAttachment(upload.files[0])"
          style="display:none">
        <div if.bind="attachment.url" style="width: 100%; padding-top:56px; padding-bottom:129%; position:relative;">
          <embed
            src.bind="attachment.url"
            type.bind="attachment.type"
            style="position:absolute; height:100%; width:100%; top:0; bottom:0">
        </div> -->
        <!-- The above padding / positioning keeps a constant aspect ratio for the embeded pdf  -->
      </div>
      <div class="mdl-card__actions">
        <md-button color raised
          style="width:100%"
          if.bind="! shipment._id && ! tracking._id"
          disabled.bind="! from.name || ! to.name"
          click.delegate="createShipment()">
          Create Shipment With ${ numChecks ? 'Selected' : 'No Items'}
        </md-button>
        <md-button color raised
          style="width:100%"
          if.bind="shipment._id && shipment._id == tracking._id && role.account == 'to'"
          disabled.bind="! diffs.length"
          click.delegate="saveInventory()">
          Save Selected to Inventory
        </md-button>
        <md-button color raised
          style="width:100%"
          if.bind="shipment._id != tracking._id"
          disabled.one-way="! numChecks || ! to.name"
          click.delegate="tracking._id ? moveShipment() : createShipment()">
          Move Selected to Shipment
        </md-button>
      </div>
    </div>
    <div md-shadow="2" class="mdl-card mdl-cell mdl-cell--8-col full-height">
      <!-- disabled.bind="! searchReady" -->
      <md-autocomplete
        placeholder.bind="loading.length ? (loading[0] == 'drugs' ? 'Loading Drug Database. This may take a few minutes...' :  loading[0]) : 'Add Drugs by Generic Name or NDC...'"
        disabled.bind="loading.length"
        value.bind="term"
        input.delegate="search()"
        keyup.delegate="autocompleteShortcut($event)"
        style="margin:0px 16px">
        <table md-table>
          <tr
            repeat.for="drug of drugs"
            click.delegate="addTransaction(drug)">
            <td class="mdl-data-table__cell--non-numeric" innerHTML.bind="drug | drugName:regex" style="white-space:normal; max-width:70%"></td>
            <td class="mdl-data-table__cell--non-numeric" style="max-width:30%">${ drug._id }</td>
          </tr>
        </table>
      </md-autocomplete>
      <button id="import-export"
        style="position:absolute; z-index:2; text-align:right; top:10px; right:5px;"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">more_vert</i>
      </button>
      <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="import-export">
        <!-- workaround for boolean attributes https://github.com/aurelia/templating/issues/76 -->
        <li
          show.bind="transactions.length"
          click.delegate="exportCSV()"
          class="mdl-menu__item">
          Export CSV
        </li>
        <li
          show.bind="!transactions.length"
          disabled
          class="mdl-menu__item">
          Export CSV
        </li>
        <li
          click.delegate="$file.click()"
          class="mdl-menu__item">
          Import CSV
        </li>
      </ul>
      <input ref="$file" change.delegate="importCSV()" style="display:none" type="file" />
      <div style="overflow-y:scroll; margin:8px 0px 8px 16px;">
        <table md-table style="width:calc(100% - 16px)">
          <thead>
            <tr>
              <th></th>
              <th class="mdl-data-table__cell--non-numeric" style="padding-left:0">Drug</th>
              <th class="mdl-data-table__cell--non-numeric" style="width:90px;padding-left:0">Ndc</th>
              <th style="text-align:left; width:40px; padding:initial 0">Exp</th>
              <th style="text-align:left; width:40px">Qty</th>
              <th style="text-align:left; width:10px; padding:initial 0"></th>
            </tr>
          </thead>
          <tbody>
            <tr style="padding-top:7px;" repeat.for="transaction of transactions">
              <td style="width:15px; padding:0 0 0 8px">
                <md-checkbox
                  disabled.bind="disabled"
                  checked.one-way="isChecked[$index]"
                  click.delegate="manualCheck($index)"
                  focusin.delegate="selectRow($index)">
                </md-checkbox>
              </td>
              <td click.delegate="selectRow($index)" class="mdl-data-table__cell--non-numeric" style="max-width:300px; white-space:normal; padding-left:0">
                ${ transaction.drug | drugName }
              </td>
              <td click.delegate="selectRow($index)" class="mdl-data-table__cell--non-numeric" style="padding:0">
                ${ transaction.drug._id }
                <!-- <md-select
                  style="margin-left:-3px"
                  value.bind="package"
                  options.bind="['', '00','01','10','90']">
                </md-select> -->
              </td>
              <td style="padding:0">
                ${ transaction.exp[role.partner] | date}
                <md-input
                  id.bind="'exp_'+$index"
                  ref="input"
                  input.delegate="saveTransaction(transaction) & debounce:1000"
                  input.trigger="autoCheck($index)"
                  pattern="(0?[1-9]|1[012])/\d{2}"
                  value.bind="transaction.exp[role.account] | date"
                  style="width:40px;"
                  placeholder>
                </md-input>

              </td>
              <td style="padding:0">
                ${ transaction.qty[role.partner] }
                  <!-- input event is not triggered on enter, so use keyup for qtyShortcutes instead   -->
                  <md-input
                    input.delegate="saveTransaction(transaction) & debounce:1000"
                    keyup.delegate="qtyShortcuts($event, $index)"
                    type="number"
                    value.bind="transaction.qty[role.account]"
                    style="width:40px;"
                    placeholder>
                  </md-input>
              </td>
              <td style="padding:0 16px">
                <a if.bind="shipment._id" href="/#/records/${ transaction._id }" tabindex="-1">
                   <i class="material-icons" style="font-size:15px; vertical-align:text-top">history</i>
                </a>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <md-snackbar ref="snackbar"></md-snackbar>
  </section>
</template>
